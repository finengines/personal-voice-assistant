<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Server Management - Personal Voice Assistant</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
            text-align: center;
        }
        
        .navigation {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .nav-link {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;
            text-decoration: none;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 25px;
            transition: all 0.3s;
        }
        
        .nav-link:hover {
            background: #667eea;
            color: white;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .server-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        
        .server-card.active {
            border-left-color: #28a745;
        }
        
        .server-card.inactive {
            border-left-color: #dc3545;
        }
        
        .server-card.disabled {
            border-left-color: #6c757d;
            opacity: 0.7;
        }
        
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .server-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .server-status {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-disabled {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .server-info {
            color: #666;
            margin-bottom: 15px;
        }
        
        .server-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .tools-list {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .tool-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #667eea;
        }
        
        .tool-name {
            font-weight: 600;
            color: #333;
        }
        
        .tool-description {
            color: #666;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .server-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .server-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß MCP Server Management</h1>
        
        <div class="navigation">
            <a href="index.html" class="nav-link">‚Üê Back to Voice Assistant</a>
            <a href="#" class="nav-link" onclick="refreshServers()">üîÑ Refresh</a>
        </div>
        
        <!-- Server Status Overview -->
        <div class="section">
            <h2>üìä Server Overview</h2>
            <div class="button-group">
                <button class="btn btn-primary" onclick="showAddServerModal()">‚ûï Add Server</button>
                <button class="btn btn-success" onclick="startAllServers()">‚ñ∂Ô∏è Start All</button>
                <button class="btn btn-warning" onclick="stopAllServers()">‚èπÔ∏è Stop All</button>
                <button class="btn btn-info" onclick="showToolsModal()">üõ†Ô∏è View All Tools</button>
            </div>
            <div id="overview-stats"></div>
        </div>
        
        <!-- Servers List -->
        <div class="section">
            <h2>üñ•Ô∏è MCP Servers</h2>
            <div id="servers-list">
                <div class="loading">Loading servers...</div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Server Modal -->
    <div id="serverModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">Add MCP Server</h2>
            <div id="modal-error" class="error" style="display: none;"></div>
            <form id="serverForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="server-id">Server ID</label>
                        <input type="text" id="server-id" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="server-name">Name</label>
                        <input type="text" id="server-name" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="server-description">Description</label>
                    <input type="text" id="server-description" class="form-control">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="server-type">Server Type</label>
                        <select id="server-type" class="form-control" onchange="updateFormFields()">
                            <option value="sse">SSE (Server-Sent Events)</option>
                            <option value="http">HTTP (Streamable)</option>
                            <option value="openai_tools">OpenAI Tools Format</option>
                            <option value="stdio">STDIO (Local)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="server-enabled">Enabled</label>
                        <select id="server-enabled" class="form-control">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                
                <div id="url-fields">
                    <div class="form-group">
                        <label for="server-url">Server URL</label>
                        <input type="url" id="server-url" class="form-control">
                    </div>
                </div>
                
                <div id="stdio-fields" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="server-command">Command</label>
                            <input type="text" id="server-command" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="server-args">Arguments (comma-separated)</label>
                            <input type="text" id="server-args" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="auth-type">Authentication Type</label>
                    <select id="auth-type" class="form-control" onchange="updateAuthFields()">
                        <option value="none">None</option>
                        <option value="bearer">Bearer Token</option>
                        <option value="api_key">API Key</option>
                        <option value="basic">Basic Auth</option>
                        <option value="custom_header">Custom Header</option>
                    </select>
                </div>
                
                <div id="auth-fields"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="server-timeout">Timeout (seconds)</label>
                        <input type="number" id="server-timeout" class="form-control" value="5" min="1" max="60">
                    </div>
                    <div class="form-group">
                        <label for="server-sse-timeout">SSE Read Timeout (seconds)</label>
                        <input type="number" id="server-sse-timeout" class="form-control" value="300" min="10" max="3600">
                    </div>
                </div>
                
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">üíæ Save Server</button>
                    <button type="button" class="btn" onclick="closeModal()">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Tools Modal -->
    <div id="toolsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeToolsModal()">&times;</span>
            <h2>üõ†Ô∏è Available Tools</h2>
            <div id="tools-content">
                <div class="loading">Loading tools...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8082';
        let servers = {};
        let currentEditingId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadServers();
        });

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Load and display servers
        async function loadServers() {
            try {
                const response = await apiCall('/servers');
                if (response.success) {
                    servers = {};
                    response.data.forEach(server => {
                        servers[server.server_id] = server;
                    });
                    displayServers();
                    updateOverview();
                } else {
                    showError('Failed to load servers: ' + response.message);
                }
            } catch (error) {
                showError('Failed to connect to MCP API: ' + error.message);
            }
        }

        function displayServers() {
            const container = document.getElementById('servers-list');
            
            if (Object.keys(servers).length === 0) {
                container.innerHTML = '<div class="loading">No MCP servers configured. Click "Add Server" to get started.</div>';
                return;
            }
            
            container.innerHTML = Object.values(servers).map(server => `
                <div class="server-card ${server.active ? 'active' : (server.enabled ? 'inactive' : 'disabled')}">
                    <div class="server-header">
                        <div class="server-name">${server.name}</div>
                        <div class="server-status">
                            <span class="status-badge ${server.active ? 'status-active' : (server.enabled ? 'status-inactive' : 'status-disabled')}">
                                ${server.active ? 'üü¢ Active' : (server.enabled ? 'üî¥ Inactive' : '‚ö´ Disabled')}
                            </span>
                        </div>
                    </div>
                    <div class="server-info">
                        <strong>ID:</strong> ${server.server_id}<br>
                        <strong>Type:</strong> ${server.server_type}<br>
                        ${server.url ? `<strong>URL:</strong> ${server.url}<br>` : ''}
                    </div>
                    <div class="server-actions">
                        ${!server.active && server.enabled ? 
                            `<button class="btn btn-success" onclick="startServer('${server.server_id}')">‚ñ∂Ô∏è Start</button>` : ''}
                        ${server.active ? 
                            `<button class="btn btn-warning" onclick="stopServer('${server.server_id}')">‚èπÔ∏è Stop</button>` : ''}
                        ${server.active ? 
                            `<button class="btn btn-warning" onclick="restartServer('${server.server_id}')">üîÑ Restart</button>` : ''}
                        <button class="btn btn-info" onclick="showServerDetails('${server.server_id}')">‚ÑπÔ∏è Details</button>
                        <button class="btn btn-primary" onclick="editServer('${server.server_id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteServer('${server.server_id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function updateOverview() {
            const total = Object.keys(servers).length;
            const active = Object.values(servers).filter(s => s.active).length;
            const enabled = Object.values(servers).filter(s => s.enabled).length;
            
            document.getElementById('overview-stats').innerHTML = `
                <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                    <div class="status-badge" style="background: #e9ecef; color: #333;">üìä Total: ${total}</div>
                    <div class="status-badge status-active">üü¢ Active: ${active}</div>
                    <div class="status-badge" style="background: #fff3cd; color: #856404;">‚úÖ Enabled: ${enabled}</div>
                    <div class="status-badge status-inactive">üî¥ Inactive: ${enabled - active}</div>
                </div>
            `;
        }

        // Server actions
        async function startServer(serverId) {
            try {
                const response = await apiCall(`/servers/${serverId}/start`, { method: 'POST' });
                if (response.success) {
                    showSuccess(response.message);
                    setTimeout(refreshServers, 2000); // Refresh after delay
                } else {
                    showError(response.message);
                }
            } catch (error) {
                showError('Failed to start server: ' + error.message);
            }
        }

        async function stopServer(serverId) {
            try {
                const response = await apiCall(`/servers/${serverId}/stop`, { method: 'POST' });
                if (response.success) {
                    showSuccess(response.message);
                    setTimeout(refreshServers, 1000); // Refresh after delay
                } else {
                    showError(response.message);
                }
            } catch (error) {
                showError('Failed to stop server: ' + error.message);
            }
        }

        async function restartServer(serverId) {
            try {
                const response = await apiCall(`/servers/${serverId}/restart`, { method: 'POST' });
                if (response.success) {
                    showSuccess(response.message);
                    setTimeout(refreshServers, 3000); // Refresh after delay
                } else {
                    showError(response.message);
                }
            } catch (error) {
                showError('Failed to restart server: ' + error.message);
            }
        }

        async function deleteServer(serverId) {
            if (!confirm(`Are you sure you want to delete server "${servers[serverId].name}"?`)) {
                return;
            }
            
            try {
                const response = await apiCall(`/servers/${serverId}`, { method: 'DELETE' });
                if (response.success) {
                    showSuccess(response.message);
                    refreshServers();
                } else {
                    showError(response.message);
                }
            } catch (error) {
                showError('Failed to delete server: ' + error.message);
            }
        }

        async function startAllServers() {
            try {
                const response = await apiCall('/servers/start-all', { method: 'POST' });
                if (response.success) {
                    showSuccess(response.message);
                    setTimeout(refreshServers, 3000);
                } else {
                    showError(response.message);
                }
            } catch (error) {
                showError('Failed to start all servers: ' + error.message);
            }
        }

        async function stopAllServers() {
            if (!confirm('Are you sure you want to stop all running servers?')) {
                return;
            }
            
            try {
                const response = await apiCall('/servers/stop-all', { method: 'POST' });
                if (response.success) {
                    showSuccess(response.message);
                    setTimeout(refreshServers, 2000);
                } else {
                    showError(response.message);
                }
            } catch (error) {
                showError('Failed to stop all servers: ' + error.message);
            }
        }

        async function showServerDetails(serverId) {
            try {
                const response = await apiCall(`/servers/${serverId}/status`);
                if (response.success) {
                    const data = response.data;
                    const tools = data.tools || [];
                    
                    const toolsHtml = tools.length > 0 ? 
                        `<div class="tools-list">
                            <h4>Available Tools (${tools.length}):</h4>
                            ${tools.map(tool => `
                                <div class="tool-item">
                                    <div class="tool-name">${tool.name || 'Unknown Tool'}</div>
                                </div>
                            `).join('')}
                        </div>` : 
                        '<div class="tools-list"><h4>No tools available</h4></div>';
                    
                    alert(`Server Details: ${servers[serverId].name}\n\nStatus: ${data.active ? 'Active' : 'Inactive'}\nType: ${data.type}\nTools: ${data.tools_count}\n\nClick "View All Tools" to see detailed tool information.`);
                } else {
                    showError(response.message);
                }
            } catch (error) {
                showError('Failed to get server details: ' + error.message);
            }
        }

        // Modal functions
        function showAddServerModal() {
            currentEditingId = null;
            document.getElementById('modal-title').textContent = 'Add MCP Server';
            document.getElementById('serverForm').reset();
            document.getElementById('server-id').readOnly = false;
            updateFormFields();
            updateAuthFields();
            document.getElementById('serverModal').style.display = 'block';
        }

        async function editServer(serverId) {
            try {
                // Fetch server details from API
                const response = await fetch(`${API_BASE}/servers/${serverId}`);
                if (!response.ok) {
                    throw new Error(`Failed to fetch server details: ${response.status}`);
                }
                
                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Failed to fetch server details');
                }
                
                const serverData = result.data.config;
                
                // Update modal title
                document.getElementById('modal-title').textContent = 'Edit MCP Server';
                
                // Populate form fields
                document.getElementById('server-id').value = serverData.id;
                document.getElementById('server-id').readOnly = true; // Prevent ID changes during edit
                document.getElementById('server-name').value = serverData.name;
                document.getElementById('server-description').value = serverData.description || '';
                document.getElementById('server-type').value = serverData.server_type;
                document.getElementById('server-enabled').checked = serverData.enabled;
                
                // Handle different server types
                if (serverData.server_type === 'stdio') {
                    document.getElementById('server-command').value = serverData.command || '';
                    document.getElementById('server-args').value = (serverData.args || []).join(' ');
                    document.getElementById('server-env').value = JSON.stringify(serverData.env || {}, null, 2);
                } else {
                    document.getElementById('server-url').value = serverData.url || '';
                }
                
                // Handle authentication - first set auth type and update fields
                if (serverData.auth) {
                    document.getElementById('auth-type').value = serverData.auth.type;
                } else {
                    document.getElementById('auth-type').value = 'none';
                }
                
                // Update form fields visibility based on server type
                updateFormFields();
                updateAuthFields();
                
                // AFTER updating auth fields, populate the values
                if (serverData.auth) {
                    // Wait a brief moment for DOM to update
                    setTimeout(() => {
                        const authTokenEl = document.getElementById('auth-token');
                        const authUsernameEl = document.getElementById('auth-username');
                        const authPasswordEl = document.getElementById('auth-password');
                        const authHeaderNameEl = document.getElementById('auth-header-name');
                        const authHeaderValueEl = document.getElementById('auth-header-value');
                        
                        if (serverData.auth.token && authTokenEl) {
                            authTokenEl.value = serverData.auth.token;
                        }
                        if (serverData.auth.username && authUsernameEl) {
                            authUsernameEl.value = serverData.auth.username;
                        }
                        if (serverData.auth.password && authPasswordEl) {
                            authPasswordEl.value = serverData.auth.password;
                        }
                        if (serverData.auth.header_name && authHeaderNameEl) {
                            authHeaderNameEl.value = serverData.auth.header_name;
                        }
                        if (serverData.auth.header_value && authHeaderValueEl) {
                            authHeaderValueEl.value = serverData.auth.header_value;
                        }
                    }, 100);
                }
                
                // Set the global editing ID variable
                currentEditingId = serverId;
                
                // Show the modal
                document.getElementById('serverModal').style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching server details:', error);
                alert('Failed to load server details: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('serverModal').style.display = 'none';
            currentEditingId = null; // Clear editing state
            document.getElementById('server-id').readOnly = false; // Reset ID field
            hideError();
        }

        function updateFormFields() {
            const serverType = document.getElementById('server-type').value;
            const urlFields = document.getElementById('url-fields');
            const stdioFields = document.getElementById('stdio-fields');
            
            if (serverType === 'stdio') {
                urlFields.style.display = 'none';
                stdioFields.style.display = 'block';
                document.getElementById('server-url').required = false;
                document.getElementById('server-command').required = true;
            } else {
                urlFields.style.display = 'block';
                stdioFields.style.display = 'none';
                document.getElementById('server-url').required = true;
                document.getElementById('server-command').required = false;
            }
        }

        function updateAuthFields() {
            const authType = document.getElementById('auth-type').value;
            const container = document.getElementById('auth-fields');
            
            let html = '';
            
            switch (authType) {
                case 'bearer':
                    html = `
                        <div class="form-group">
                            <label for="auth-token">Bearer Token</label>
                            <input type="text" id="auth-token" class="form-control" placeholder="your-bearer-token">
                        </div>
                    `;
                    break;
                case 'api_key':
                    html = `
                        <div class="form-group">
                            <label for="auth-token">API Key</label>
                            <input type="text" id="auth-token" class="form-control" placeholder="your-api-key">
                        </div>
                    `;
                    break;
                case 'basic':
                    html = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="auth-username">Username</label>
                                <input type="text" id="auth-username" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="auth-password">Password</label>
                                <input type="password" id="auth-password" class="form-control">
                            </div>
                        </div>
                    `;
                    break;
                case 'custom_header':
                    html = `
                        <div class="form-row">
                            <div class="form-group">
                                <label for="auth-header-name">Header Name</label>
                                <input type="text" id="auth-header-name" class="form-control" placeholder="X-Custom-Auth">
                            </div>
                            <div class="form-group">
                                <label for="auth-header-value">Header Value</label>
                                <input type="text" id="auth-header-value" class="form-control">
                            </div>
                        </div>
                    `;
                    break;
            }
            
            container.innerHTML = html;
        }

        // Form submission
        document.getElementById('serverForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const serverData = {
                id: document.getElementById('server-id').value,
                name: document.getElementById('server-name').value,
                description: document.getElementById('server-description').value,
                server_type: document.getElementById('server-type').value,
                enabled: document.getElementById('server-enabled').value === 'true',
                timeout: parseFloat(document.getElementById('server-timeout').value),
                sse_read_timeout: parseFloat(document.getElementById('server-sse-timeout').value)
            };
            
            // Add URL or command based on server type
            if (serverData.server_type === 'stdio') {
                serverData.command = document.getElementById('server-command').value;
                const args = document.getElementById('server-args').value;
                if (args) {
                    serverData.args = args.split(',').map(arg => arg.trim());
                }
            } else {
                serverData.url = document.getElementById('server-url').value;
            }
            
            // Add authentication
            const authType = document.getElementById('auth-type').value;
            if (authType !== 'none') {
                serverData.auth = { type: authType };
                
                switch (authType) {
                    case 'bearer':
                    case 'api_key':
                        serverData.auth.token = document.getElementById('auth-token').value;
                        break;
                    case 'basic':
                        serverData.auth.username = document.getElementById('auth-username').value;
                        serverData.auth.password = document.getElementById('auth-password').value;
                        break;
                    case 'custom_header':
                        serverData.auth.header_name = document.getElementById('auth-header-name').value;
                        serverData.auth.header_value = document.getElementById('auth-header-value').value;
                        break;
                }
            }
            
            try {
                const endpoint = currentEditingId ? `/servers/${currentEditingId}` : '/servers';
                const method = currentEditingId ? 'PUT' : 'POST';
                
                const response = await apiCall(endpoint, {
                    method: method,
                    body: JSON.stringify(serverData)
                });
                
                if (response.success) {
                    showSuccess(response.message);
                    closeModal();
                    refreshServers();
                } else {
                    showModalError(response.message);
                }
            } catch (error) {
                showModalError('Failed to save server: ' + error.message);
            }
        });

        // Tools modal
        async function showToolsModal() {
            document.getElementById('toolsModal').style.display = 'block';
            
            try {
                const response = await apiCall('/tools');
                if (response.success) {
                    const tools = response.data;
                    
                    if (tools.length === 0) {
                        document.getElementById('tools-content').innerHTML = 
                            '<div class="loading">No tools available. Start some MCP servers to see their tools.</div>';
                    } else {
                        document.getElementById('tools-content').innerHTML = 
                            tools.map(tool => `
                                <div class="tool-item">
                                    <div class="tool-name">${tool.name}</div>
                                    <div class="tool-description">${tool.description}</div>
                                    <div style="color: #999; font-size: 0.8em; margin-top: 5px;">
                                        Server: ${tool.server_name} (${tool.server_id})
                                    </div>
                                </div>
                            `).join('');
                    }
                } else {
                    document.getElementById('tools-content').innerHTML = 
                        `<div class="error">Failed to load tools: ${response.message}</div>`;
                }
            } catch (error) {
                document.getElementById('tools-content').innerHTML = 
                    `<div class="error">Failed to connect to API: ${error.message}</div>`;
            }
        }

        function closeToolsModal() {
            document.getElementById('toolsModal').style.display = 'none';
        }

        // Utility functions
        function refreshServers() {
            loadServers();
        }

        function showError(message) {
            // Simple alert for now - could be improved with a better notification system
            alert('Error: ' + message);
        }

        function showSuccess(message) {
            // Simple alert for now - could be improved with a better notification system
            alert('Success: ' + message);
        }

        function showModalError(message) {
            const errorDiv = document.getElementById('modal-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('modal-error').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const serverModal = document.getElementById('serverModal');
            const toolsModal = document.getElementById('toolsModal');
            
            if (event.target === serverModal) {
                closeModal();
            }
            if (event.target === toolsModal) {
                closeToolsModal();
            }
        }
    </script>
</body>
</html> 