# Personal Voice Assistant

Real-time voice assistant with LiveKit, React frontend, Python FastAPI services, and Model Context Protocol (MCP) tool integration. Ships with Docker-based dev/prod, PostgreSQL persistence, token server, authentication, presets, and global settings management.

## 🚀 What’s Included

- **Live voice**: LiveKit-powered, low-latency voice chat
- **AI providers**: OpenAI for LLM, Deepgram for STT; optional Cartesia/ElevenLabs for TTS; Groq/Anthropic/OpenRouter keys supported
- **MCP tools**: Manage external tools via MCP (SSE/HTTP/STDIO, OpenAI Tools format)
- **Authentication**: Simple auth (single admin via env) with JWT, optional TOTP
- **Presets & settings**: Agent presets and global settings APIs
- **Token server**: Issues LiveKit tokens for the UI
- **PostgreSQL**: Persistent config storage; auto-init via `init.sql`
- **Docker-first**: Dev compose (bundles LiveKit) and production compose (Dokploy-ready)

## 🧱 Project Structure

```
personal-voice-assistant/
├─ backend/
│  ├─ api/                  # FastAPI routers: auth, MCP, presets, global settings
│  ├─ core/                 # Agent worker, DB, services
│  │  ├─ agent_worker.py    # LiveKit single-agent worker (entry point used in dev/prod)
│  │  └─ init.sql           # DB bootstrap (run by Postgres container)
│  ├─ requirements/         # Requirements sets (agent/auth/db/mcp)
│  ├─ utils/simple_token_server.py
│  ├─ start_all.py          # Starts auth, MCP, presets, global settings, then agent
│  ├─ start_simple_auth_server.py
│  ├─ start_preset_server.py
│  └─ start_global_settings_api.py
├─ frontend/                # React + Vite app (served via Nginx in Docker)
├─ docker-compose.yml       # Development (includes local LiveKit server)
├─ docker-compose.prod.yml  # Production (external LiveKit, no host ports)
├─ env.example              # Copy to .env and fill in secrets
└─ docs/                    # Additional guides
```

## ⚙️ Prerequisites

- Docker and Docker Compose
- API keys: at minimum `OPENAI_API_KEY` and `DEEPGRAM_API_KEY`

## 🔧 Configure Environment

1) Copy example env and edit values:

```bash
cp env.example .env
```

Key entries to set (see `.env` for all):
- `OPENAI_API_KEY`, `DEEPGRAM_API_KEY`
- `JWT_SECRET`, `API_KEY_ENCRYPTION_KEY` (both can be generated by `scripts/setup_auth.sh`)
- `ADMIN_EMAIL`, `ADMIN_PASSWORD` (used to log into the UI)

Optional providers: `ELEVENLABS_API_KEY`, `CARTESIA_API_KEY`, `GROQ_API_KEY`, `ANTHROPIC_API_KEY`, `OPENROUTER_API_KEY`.

## 🧪 Development (Docker)

Start the full stack (LiveKit, Postgres, backend APIs, token server, frontend):

```bash
docker compose up -d
docker compose ps
```

Services and ports (dev):
- Frontend: `http://localhost:8080`
- Auth API: `http://localhost:8001` (docs at `/docs`)
- MCP API: `http://localhost:8082` (health at `/health`)
- Preset API: `http://localhost:8083` (health at `/health`)
- Global Settings API: `http://localhost:8084` (health at `/health`)
- Token server: `http://localhost:8081/health`
- LiveKit (dev container): `ws://localhost:7883`

Login to the UI with `ADMIN_EMAIL` / `ADMIN_PASSWORD` from `.env`.

## 🖥️ Using the App

- **Voice**: Open the Voice tab, generate a token from Settings, Connect, allow mic, speak.
- **MCP**: Add/enable servers; statuses and tools are surfaced from the MCP API.
- **Presets**: Create/select agent presets; switching presets reconnects the agent.
- **API Keys**: Manage encrypted API keys via the MCP API.
- **Global**: System-wide defaults and environment information.

The frontend autodetects localhost vs container routing (see `frontend/src/config.js`).

## 🧩 Local Development (without Docker)

Backend (Python 3.10+ recommended):
```bash
python -m venv .venv && source .venv/bin/activate
pip install -r backend/requirements/requirements-agent.txt \
            -r backend/requirements/requirements-db.txt \
            -r backend/requirements/requirements-mcp.txt

# Start APIs and agent worker
cd backend
python start_all.py

# In another terminal (token server)
python backend/utils/simple_token_server.py
```

LiveKit options:
- Use the dev LiveKit container: `docker compose up -d livekit`
- Or LiveKit Cloud: set `LIVEKIT_URL`, `LIVEKIT_API_KEY`, `LIVEKIT_API_SECRET` in `.env`

Frontend:
```bash
cd frontend
npm install
npm run dev
# Open the dev server URL (typically http://localhost:5173)
```

## 🗄️ Database

PostgreSQL is provisioned by Docker with `backend/core/init.sql`. SQLAlchemy creates tables on app start. To migrate JSON configs into DB or create defaults, see `scripts/setup_database.sh` (used primarily with Docker).

## 🔌 Key Endpoints

- Auth API: `/auth/health`, `/docs`
- MCP API: `/health`, `/servers`, `/tools`, start/stop/restart per server
- Preset API: `/health`, preset CRUD
- Global Settings API: `/health`
- Token Server: `/` (issues token), `/health`

## 🛡️ Security Notes

- Configure strong `JWT_SECRET` and `API_KEY_ENCRYPTION_KEY` (use `scripts/setup_auth.sh` to generate)
- For production, use HTTPS and external LiveKit (or LiveKit Cloud)
- Lock down CORS in production (defaults are permissive for dev)

## 🚀 Production (Dokploy/Containers)

Use the production compose (no host ports, expects external LiveKit):

```bash
docker compose -f docker-compose.prod.yml up -d --build
```

Requirements:
- External LiveKit URL and credentials
- Proper secrets in `.env`
- SSL/TLS handled by your platform (e.g., Dokploy)

## 🤝 Contributing

1) Fork and create a feature branch
2) Make changes following clean architecture and code quality standards
3) Ensure Docker dev build and basic flows work
4) Open a PR

## 📄 License

MIT – see `LICENSE`.